# CoAP API Reference

The functions explained below are defined inside the file *include/iowa_coap.h*.

## CoAP client pseudo code

```c
#include "iowa_coap.h"

int main(int argc,
         char *argv[])
{
    iowa_context_t iowaH;
    iowa_coap_peer_t *peerP;
    iowa_status_t result;

    /******************
    * Initialization
    */

    iowaH = iowa_init(NULL);

    peerP = iowa_coap_peer_new(iowaH,
                               "coap://coap.example.com",
                               IOWA_SEC_NONE,
                               NULL,
                               prv_coapEventCallback, NULL);

    result = iowa_coap_peer_connect(iowaH, peerP);

    /******************
    * "Main loop"
    */

    while (result == IOWA_COAP_NO_ERROR)
    {
        result = iowa_step(iowaH, 10);
    }

    iowa_coap_peer_delete(iowaH, peerP);

    iowa_close(iowaH);
    close(serverSocket);

    return 0;
}

void prv_coapEventCallback(iowa_coap_peer_t *fromPeer,
                           iowa_coap_event_t event,
                           void *userData,
                           iowa_context_t contextP)
{
    if (event == COAP_EVENT_CONNECTED)
    {
        iowa_status_t result;

        // Sending a GET on "/test"

        result = iowa_coap_peer_get(contextP, fromPeer, "/test", prv_resultCallback, userData);
    }
    else if (event == COAP_EVENT_DISCONNECTED)
    {
        iowa_coap_peer_delete(contextP, fromPeer);
    }
}

void prv_resultCallback(iowa_coap_peer_t *fromPeer,
                        uint8_t code,
                        iowa_coap_message_t *responseP,
                        void *userData,
                        iowa_context_t contextP)
{
    printf("Result for GET: %u.%02u.\r\n", (code & 0xFF) >> 5, (code & 0x1F));

    if (code == IOWA_COAP_205_CONTENT)
    {
        printf("Payload: %.*s", responseP->payloadLength, responseP->payload);
    }
}

```

## Data types

### iowa_coap_peer_t

```c
typedef struct _iowa_coap_peer_t iowa_coap_peer_t;
```

`iowa_coap_peer_t` is an opaque type describing a CoAP peer.

### iowa_coap_peer_event_t

```c
typedef enum
{
    COAP_EVENT_UNDEFINED = 0,
    COAP_EVENT_CONNECTED,
    COAP_EVENT_DISCONNECTED
} iowa_coap_peer_event_t;
```

`iowa_coap_peer_event_t` contains the possible events that can be reported by a CoAP peer.

### iowa_coap_message_t

```c
typedef struct _iowa_coap_message_t iowa_coap_message_t;
```

`iowa_coap_message_t` is an opaque type describing a CoAP message.

### iowa_coap_setting_id_t

```c
typedef uint8_t iowa_coap_setting_id_t;
```

#### Possible Values

**IOWA_COAP_SETTING_ACK_TIMEOUT**
: The RFC7252 ACK_TIMEOUT value as an *uint8_t*.

**IOWA_COAP_SETTING_MAX_RETRANSMIT**
: The RFC7252 MAX_RETRANSMIT value as an *uint8_t*.

**IOWA_COAP_SETTING_URI_LENGTH**
: The length in bytes of the URI as a *size_t*. This is a read-only setting.

**IOWA_COAP_SETTING_URI**
: The URI as a *char \**. This is a read-only setting. The passed argument must point to a buffer of at least the size indicated by  **IOWA_COAP_SETTING_URI_LENGTH**.

\clearpage

## Callbacks

### iowa_coap_result_callback_t

The CoAP APIs [`iowa_coap_peer_get()`](CoapAPI.md#iowa_coap_peer_get) and  [`iowa_coap_block_request_next()`](CoapAPI.md#iowa_coap_block_request_next) are using an `iowa_coap_result_callback_t` to asynchronously return the result of the operation.

```c
typedef void(*iowa_coap_result_callback_t)(iowa_coap_peer_t *fromPeer,
                                           uint8_t code,
                                           iowa_coap_message_t *messageP,
                                           void *userData,
                                           iowa_context_t contextP);
```

*fromPeer*
: The CoAP peer we sent the request to.

*code*
: The Code of the CoAP Message or the result of the transmission.

*messageP*
: The received CoAP Message. This can be nil.

*userData*
: The [`iowa_coap_peer_get()`](CoapAPI.md#iowa_coap_peer_get) or [`iowa_coap_block_request_next()`](CoapAPI.md#iowa_coap_block_request_next) parameter.

*contextP*
: The IOWA context on which the CoAP API ([`iowa_coap_peer_get()`](CoapAPI.md#iowa_coap_peer_get) or [`iowa_coap_block_request_next()`](CoapAPI.md#iowa_coap_block_request_next)) was called.

### iowa_coap_peer_event_callback_t

```c
typedef void(*iowa_coap_peer_event_callback_t)(iowa_coap_peer_t *fromPeer,
                                               iowa_coap_peer_event_t event,
                                               void *userData,
                                               iowa_context_t contextP);
```

*fromPeer*
: The CoAP peer which generated the event.

*event*
: The event generated by the peer. See [`iowa_coap_peer_event_t`](CoapAPI.md#iowa_coap_peer_event_t).

*userData*
: The [`iowa_coap_peer_new()`](CoapAPI.md#iowa_coap_peer_new) parameter.

*contextP*
: The IOWA context on which [`iowa_coap_peer_new()`](CoapAPI.md#iowa_coap_peer_new) was called.

\clearpage

## API

### iowa_coap_peer_new

** Prototype **

```c
iowa_coap_peer_t *iowa_coap_peer_new(iowa_context_t contextP,
                                     const char *uri,
                                     iowa_security_mode_t securityMode,
                                     iowa_coap_peer_event_callback_t eventCb,
                                     void *callbackUserData);
```

** Description **

`iowa_coap_peer_new()` creates a new CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*uri*
: The URI of the CoAP peer.

*securityMode*
: The security to use with this CoAP peer. See [`iowa_security_mode_t`](Security.md#iowa_security_mode_t).

*eventCb*
: The callback to call when this CoAP peer generates an event.

*callbackUserData*
: A pointer to application specific data. This is passed as argument to *messageCb* and *eventCb*. This can be nil.

** Return Value **

A pointer to an [`iowa_coap_peer_t`](CoapAPI.md#iowa_coap_peer_t) in case of success or NULL in case of memory allocation error, invalid URI, or if [`iowa_system_connection_open()`](AbstractionLayer.md#iowa_system_connection_open) returned an error.

** Header File **

iowa_coap.h

\clearpage

### iowa_coap_peer_delete

** Prototype **

```c
void iowa_coap_peer_delete(iowa_context_t contextP,
                           iowa_coap_peer_t *peerP);
```

** Description **

`iowa_coap_peer_delete()` closes a CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*peerP*
: The CoAP peer to close. This can be nil.

** Header File **

iowa_coap.h

\clearpage

### iowa_coap_peer_configuration_set

** Prototype **

```c
iowa_status_t iowa_coap_peer_configuration_set(iowa_context_t contextP,
                                               iowa_coap_peer_t *peerP,
                                               iowa_coap_setting_id_t settingId,
                                               void *argP);
```

** Description **

`iowa_coap_peer_configuration_set()` configures the settings of a CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*peerP*
: The CoAP peer to configure.

*settingId*
: The setting to set. See [`iowa_coap_setting_id_t`](CoapAPI.md#iowa_coap_setting_id_t).

*argP*
: A pointer to the setting value. Dependent on *settingId*.

** Return Value **

IOWA_COAP_NO_ERROR
: success.

IOWA_COAP_402_BAD_OPTION
: *peerP* is nil.

IOWA_COAP_405_METHOD_NOT_ALLOWED
: *settingId* is not valid for this peer type.

IOWA_COAP_422_UNPROCESSABLE_ENTITY
: *peerP* is of an unsupported type.

** Header File **

iowa_coap.h

\clearpage

### iowa_coap_peer_configuration_get

** Prototype **

```c
iowa_status_t iowa_coap_peer_configuration_get(iowa_context_t contextP,
                                               iowa_coap_peer_t *peerP,
                                               iowa_coap_setting_id_t settingId,
                                               void *argP);
```

** Description **

`iowa_coap_peer_configuration_get()` retrieves the value of a setting of a CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*peerP*
: The CoAP peer to retrieve the setting from.

*settingId*
: The setting to retrieve. See [`iowa_coap_setting_id_t`](CoapAPI.md#iowa_coap_setting_id_t).

*argP*
: A pointer to store the setting value. Dependent on *settingId*.

** Return Value **

IOWA_COAP_NO_ERROR
: success.

IOWA_COAP_402_BAD_OPTION
: *peerP* is nil.

IOWA_COAP_405_METHOD_NOT_ALLOWED
: *settingId* is not valid for this peer type.

IOWA_COAP_422_UNPROCESSABLE_ENTITY
: *peerP* is of an unsupported type.

** Header File **

iowa_coap.h

\clearpage

### iowa_coap_peer_connect

** Prototype **

```c
iowa_status_t iowa_coap_peer_connect(iowa_context_t contextP,
                                     iowa_coap_peer_t *peerP);
```

** Description **

`iowa_coap_peer_connect()` opens a connection with a CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*peerP*
: The CoAP peer to connect.

** Return Value **

IOWA_COAP_NO_ERROR
: success.

IOWA_COAP_402_BAD_OPTION
: *peerP* is nil.

** Header File **

iowa_coap.h

** Notes **

The actual result of the connection is indicated by a call to the [`iowa_coap_peer_event_callback_t`](CoapAPI.md#iowa_coap_peer_event_callback_t) associated to the CoAP peer.

\clearpage

### iowa_coap_peer_disconnect

** Prototype **

```c
void iowa_coap_peer_disconnect(iowa_context_t contextP,
                               iowa_coap_peer_t *peerP);
```

** Description **

`iowa_coap_peer_disconnect()` closes a connection with a CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*peerP*
: The CoAP peer to disconnect. This can be nil.

** Return Value **

None.

** Header File **

iowa_coap.h

** Notes **

The actual result of the disconnection is indicated by a call to the [`iowa_coap_peer_event_callback_t`](CoapAPI.md#iowa_coap_peer_event_callback_t) associated to the CoAP peer.

\clearpage

### iowa_coap_peer_get

** Prototype **

```c
iowa_status_t iowa_coap_peer_get(iowa_context_t contextP,
                                 iowa_coap_peer_t *peerP,
                                 const char *path,
                                 const char *query,
                                 iowa_coap_result_callback_t resultCb,
                                 void *userData);
```

** Description **

`iowa_coap_peer_get()` sends a CoAP GET request to a CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*peerP*
: The CoAP peer to send the request to.

*path*
: The path component of the uri to retrieve. This can be nil.

*query*
: The query component of the uri to retrieve. This can be nil.

*resultCb*
: The callback to call when a reply is received or when the transmission fails.

*userData*
: A pointer to application specific data. This is passed as argument to *resultCb*. This can be nil.

** Return Value **

IOWA_COAP_NO_ERROR
: success.

IOWA_COAP_402_BAD_OPTION
: *peerP* or *resultCb* is nil.

IOWA_COAP_500_INTERNAL_SERVER_ERROR
: either:
: - a memory allocation failed.
: - [`iowa_system_gettime()`](AbstractionLayer.md#iowa_system_gettime) returned an error.

IOWA_COAP_503_SERVICE_UNAVAILABLE
: either:
: - the CoAP peer is not connected.
: - [`iowa_system_connection_send()`](AbstractionLayer.md#iowa_system_connection_send) returned an error.

** Header File **

iowa_coap.h

\clearpage

### iowa_coap_message_get_payload

** Prototype **

```c
size_t iowa_coap_message_get_payload(iowa_coap_message_t *messageP,
                                     iowa_content_format_t *formatP,
                                     uint8_t **payloadP);
```

** Description **

`iowa_coap_message_get_payload()` retrieves the pointer to the payload of a CoAP message.

** Arguments **

*messageP*
: the CoAP message to inspect.

*formatP*
: OUT. The content format of the payload. This can be nil.

*payloadP*
: OUT. A pointer to the payload of the message. This can be nil.

** Return Value **

The length in bytes of the payload.

** Notes **

If the CoAP message has ne Content-format option, *formatP* will be set to [**IOWA_CONTENT_FORMAT_UNSET**](CommonAPI.md#iowa_content_format_t).

** Header File **

iowa_coap.h

\clearpage

### iowa_coap_message_get_block_info

** Prototype **

```c
iowa_status_t iowa_coap_message_get_block_info(iowa_coap_message_t *messageP,
                                               uint32_t *numberP,
                                               bool *moreP,
                                               uint16_t *sizeP);
```

** Description **

`iowa_coap_message_get_block_info()` retrieves block information in a CoAP message.

** Arguments **

*messageP*
: the CoAP message to inspect.

*numberP*
: OUT. the block number.

*moreP*
: OUT. true if there are more blocks coming.

*sizeP*
: OUT. the size of the block.

** Return Value **

IOWA_COAP_NO_ERROR
: success.

IOWA_COAP_404_NOT_FOUND
: if the CoAP message has no block information.

** Header File **

iowa_coap.h

\clearpage

### iowa_coap_block_request_next

** Prototype **

```c
iowa_status_t iowa_coap_block_request_next(iowa_context_t contextP,
                                           iowa_coap_peer_t *peerP,
                                           iowa_coap_message_t *messageP,
                                           iowa_coap_message_callback_t resultCb,
                                           void *userData);
```

** Description **

When receiving a reply with a block option, `iowa_coap_block_request_next()` requests the next block from the CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*peerP*
: The CoAP peer to send the message to.

*messageP*
: The CoAP message containing the previous block.

*resultCb*
: The callback to call when the next block is received, or if an error occurs.

*userData*
: A pointer to application specific data. This is passed as argument to *resultCb*. This can be nil.

** Return Value **

IOWA_COAP_NO_ERROR
: success.

IOWA_COAP_402_BAD_OPTION
: *peerP* or *messageP* is nil.

IOWA_COAP_500_INTERNAL_SERVER_ERROR
: either:
: - a memory allocation failed.
: - [`iowa_system_gettime()`](AbstractionLayer.md#iowa_system_gettime) returned an error.

IOWA_COAP_503_SERVICE_UNAVAILABLE
: either:
: - the CoAP peer is not connected.
: - [`iowa_system_connection_send()`](AbstractionLayer.md#iowa_system_connection_send) returned an error.

** Notes **

IOWA must be compiled with the flag [**IOWA_COAP_BLOCK_SUPPORT**][Additional flags].

** Header File **

iowa_coap.h

\clearpage

### iowa_coap_block_request_block_number

** Prototype **

```c
uint8_t iowa_coap_block_request_block_number(iowa_context_t contextP,
                                             iowa_coap_peer_t *peerP,
                                             iowa_coap_message_t *messageP,
                                             uint32_t blockNumber,
                                             iowa_coap_result_callback_t resultCb,
                                             void *userData);
```

** Description **

When receiving a reply with a block option, `iowa_coap_block_request_block_number()` requests a specific block from the CoAP peer.

** Arguments **

*contextP*
: An [`iowa_context_t`](CommonAPI.md#iowa_context_t) as returned by [`iowa_init()`](CommonAPI.md#iowa_init). Not checked at runtime.

*peerP*
: The CoAP peer to send the message to.

*messageP*
: The CoAP message containing the block transfer.

*blockNumber*
: the block number.

*resultCb*
: The callback to call when the block is received, or if an error occurs.

*userData*
: A pointer to application specific data. This is passed as argument to *resultCb*. This can be nil.

** Return Value **

IOWA_COAP_NO_ERROR
: success.

IOWA_COAP_402_BAD_OPTION
: *peerP* or *messageP* is nil.

IOWA_COAP_500_INTERNAL_SERVER_ERROR
: either:
: - a memory allocation failed.
: - [`iowa_system_gettime()`](AbstractionLayer.md#iowa_system_gettime) returned an error.

IOWA_COAP_503_SERVICE_UNAVAILABLE
: either:
: - the CoAP peer is not connected.
: - [`iowa_system_connection_send()`](AbstractionLayer.md#iowa_system_connection_send) returned an error.

** Notes **

IOWA must be compiled with the flag [**IOWA_COAP_BLOCK_SUPPORT**][Additional flags].

** Header File **

iowa_coap.h

\clearpage

## Helper Functions

### iowa_coap_uri_parse

** Prototype **

```c
iowa_status_t iowa_coap_uri_parse(const char *uri,
                                  iowa_connection_type_t *typeP,
                                  char **hostnameP,
                                  char **portP,
                                  char **pathP,
                                  char **queryP,
                                  bool *isSecureP);
```

** Description **

`iowa_coap_uri_parse()` parses an URI and may return its type, hostname, port, path, and query.

** Arguments **

*uri*
: the URI to parse.

*typeP*
: OUT. the connection type.

*hostnameP*
: OUT. the hostname. This can be nil.

*portP*
: OUT. the port. This can be nil.

*pathP*
: OUT. the path. This can be nil.

*queryP*
: OUT. the path. This can be nil.

*isSecureP*
: OUT. inform if the connection is secured.

** Return Value **

IOWA_COAP_NO_ERROR
: success.

IOWA_COAP_400_BAD_REQUEST
: *uri* is nil.

IOWA_COAP_406_NOT_ACCEPTABLE
: either:
: - the URI schema has not been recognized.
: - the URI format is invalid.

IOWA_COAP_500_INTERNAL_SERVER_ERROR
: a memory allocation failed.

** Notes **

If *hostnameP*, *portP*, *pathP*, or *queryP* are not nil, they will point to dynamically allocated memory. It is the caller responsibility to free this memory.

** Header File **

iowa_coap.h

\clearpage
