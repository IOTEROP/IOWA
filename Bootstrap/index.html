
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ioterop.github.io/IOWA/Bootstrap/">
      
      
      <link rel="shortcut icon" href="../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.6">
    
    
      
        <title>Bootstrap - IOWA documentation (Lite)</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6910b76c.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.196e0c26.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bootstrap" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://ioterop.github.io/IOWA/" title="IOWA documentation (Lite)" class="md-header-nav__button md-logo" aria-label="IOWA documentation (Lite)">
      
  <img src="../assets/iowa_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            IOWA documentation (Lite)
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Bootstrap
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/IOTEROP/IOWA/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://ioterop.github.io/IOWA/" title="IOWA documentation (Lite)" class="md-nav__button md-logo" aria-label="IOWA documentation (Lite)">
      
  <img src="../assets/iowa_logo.png" alt="logo">

    </a>
    IOWA documentation (Lite)
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/IOTEROP/IOWA/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../License/" class="md-nav__link">
      License
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Changelog/" class="md-nav__link">
      Changelog
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../LwM2MOverview/" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../EvaluationKit/" class="md-nav__link">
      Evaluation Kit
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../AbstractionLayer/" class="md-nav__link">
      Abstraction Layer
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CommonAPI/" class="md-nav__link">
      Common APIs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ClientAPI/" class="md-nav__link">
      Client APIs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ServerAPI/" class="md-nav__link">
      Server APIs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../BootstrapServerAPI/" class="md-nav__link">
      Bootstrap Server APIs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../UtilsAPI/" class="md-nav__link">
      Utils APIs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../DeprecatedAPI/" class="md-nav__link">
      Deprecated APIs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../OpenSourceLicenses/" class="md-nav__link">
      OpenSource Licenses
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrap-mode" class="md-nav__link">
    Bootstrap Mode
  </a>
  
    <nav class="md-nav" aria-label="Bootstrap Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#factory-bootstrap" class="md-nav__link">
    Factory Bootstrap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-initiated-bootstrap" class="md-nav__link">
    Client initiated Bootstrap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flow" class="md-nav__link">
    Flow
  </a>
  
    <nav class="md-nav" aria-label="Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bootstrap-request" class="md-nav__link">
    Bootstrap Request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-bootstrap-information" class="md-nav__link">
    Getting Bootstrap Information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bootstrap-finish" class="md-nav__link">
    Bootstrap Finish
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-registration" class="md-nav__link">
    Server Registration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    Notes
  </a>
  
    <nav class="md-nav" aria-label="Notes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iowa-client-without-security" class="md-nav__link">
    IOWA Client (without Security)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iowa-client-with-security" class="md-nav__link">
    IOWA Client (with Security)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/IOTEROP/IOWA/edit/master/docs/Bootstrap.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="bootstrap">Bootstrap<a class="headerlink" href="#bootstrap" title="Permanent link">&para;</a></h1>
<p>To enable the Bootstrap Interface on the client, IOWA must be built with the flag <code>LWM2M_BOOTSTRAP</code>. Furthermore to create a LwM2M Bootstrap Server, the flag <code>LWM2M_BOOTSTRAP_SERVER_MODE</code> must be set. Note: This flag can be set with <code>LWM2M_SERVER_MODE</code>, there is no conflict.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The Bootstrap mode is used to add one or more LwM2M Server Account into the LwM2M Client.</p>
<p>IOWA currently supports the following Bootstrap mode:</p>
<ul>
<li>Factory Bootstrap</li>
<li>Client initiated Bootstrap</li>
</ul>
<p><img alt="Bootstrap Interface" src="../images/bootstrap.png" /></p>
<h2 id="bootstrap-mode">Bootstrap Mode<a class="headerlink" href="#bootstrap-mode" title="Permanent link">&para;</a></h2>
<h3 id="factory-bootstrap">Factory Bootstrap<a class="headerlink" href="#factory-bootstrap" title="Permanent link">&para;</a></h3>
<p>The LwM2M Client has, in this mode, already the LwM2M Server Account(s) configured. This mode does not require the LwM2M Client to connect to a LwM2M Bootstrap Server if the LwM2M Server accounts contain at least a LwM2M Server Information.</p>
<h3 id="client-initiated-bootstrap">Client initiated Bootstrap<a class="headerlink" href="#client-initiated-bootstrap" title="Permanent link">&para;</a></h3>
<p>If no Server have been configured and a Bootstrap Server is supplied, the Client will connect to the Bootstrap Server to obtain the connection information of at least one Server.</p>
<p>If the Client needs to connect to the Bootstrap Server with security, the keys need to be preloaded during Factory setup.</p>
<h2 id="flow">Flow<a class="headerlink" href="#flow" title="Permanent link">&para;</a></h2>
<h3 id="bootstrap-request">Bootstrap Request<a class="headerlink" href="#bootstrap-request" title="Permanent link">&para;</a></h3>
<p>After Client booting, the Client sends a Bootstrap Request operation to the preloaded Bootstrap Server.</p>
<p>On Bootstrap Request, the Bootstrap Server starts provisioning the Client with new LwM2M Server Accounts.</p>
<h3 id="getting-bootstrap-information">Getting Bootstrap Information<a class="headerlink" href="#getting-bootstrap-information" title="Permanent link">&para;</a></h3>
<p>A typical client configuration flow is:</p>
<ul>
<li>Delete everything on the Client by sending a Delete operation on URI <code>/</code>,</li>
<li>Optional step: Write a new LwM2M Bootstrap Server Account with Write operation on URI <code>/0</code>,</li>
<li>Write at least one LwM2M Server Account with Write operation on URI <code>/0</code> and <code>/1</code>.</li>
</ul>
<p>Writing a LwM2M Bootstrap Server Account is recommended. If the Client is unable to connect to the Server, it can fall back to Bootstrap mode.</p>
<p>Instead of writing manually the Object Instance through Write operation, IOWA provides for the LwM2M Bootstrap Server high level operations:</p>
<ul>
<li>Add Bootstrap Server: add a [<code>Security Object</code>][Security Object] Instance,</li>
<li>Remove Bootstrap Server: add the [<code>Security Object</code>][Security Object] Instance associated to the Bootstrap Server,</li>
<li>Add Server: add a [<code>Security Object</code>][Security Object] Instance and a [<code>Server Object</code>][Server Object] Instance,</li>
<li>Remove Server: remove the [<code>Security Object</code>][Security Object] Instance and the [<code>Server Object</code>][Server Object] Instance associated to the Server.</li>
</ul>
<p>These high level operations automatically provision the Resources of the Objects without the need to know how the Objects are structured.</p>
<h3 id="bootstrap-finish">Bootstrap Finish<a class="headerlink" href="#bootstrap-finish" title="Permanent link">&para;</a></h3>
<p>Once the LwM2M Server Account have been provisioned, the Bootstrap Server sends a Bootstrap Finish operation to start the Bootstrap Consistency check.</p>
<p>The Bootstrap Consistency checks if the information provided is correct before exiting the Bootstrap mode. If the information is incorrect, an error is sent back to the Bootstrap Server by the Client to inform that the LwM2M Server Account loaded is not consistent.</p>
<p>Bootstrap Consistency can fail for the following reasons:</p>
<ul>
<li>No Server Account provided,</li>
<li>Only one Bootstrap Server Account provided without Server Account,</li>
<li>Server URI requires a secured connection but no Security information is provided,</li>
<li>Server URI requires a non secured connection but Security information is provided,</li>
<li>Server URI requires a specific binding but the Resource Binding (ID: 7) of the [<code>Server Object</code>][Server Object] is different,</li>
<li>Security information is not consistent across the Resources Security Mode (ID: 2), Public Key or Identity (ID: 3), Server Public Key (ID: 4) and Secret Key (ID: 5) of the [<code>Security Object</code>][Security Object].</li>
</ul>
<p>If the Bootstrap Consistency passed, the Client will respond with no error to the Bootstrap Finish operation.</p>
<h3 id="server-registration">Server Registration<a class="headerlink" href="#server-registration" title="Permanent link">&para;</a></h3>
<p>Once the Bootstrap Consistency is done without error, the Client disconnects from the Bootstrap Server and starts a Registration to the loaded Server(s).</p>
<p>If the Client does not get a response from the Server and if a Bootstrap Server is configured, the Client will fall back to Bootstrap mode.</p>
<h2 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h2>
<h3 id="iowa-client-without-security">IOWA Client (without Security)<a class="headerlink" href="#iowa-client-without-security" title="Permanent link">&para;</a></h3>
<p>The Factory mode is supported through the API: <a href="../ClientAPI/#iowa_client_add_bootstrap_server"><code>iowa_client_add_bootstrap_server()</code></a> and <a href="../ClientAPI/#iowa_client_add_server"><code>iowa_client_add_server()</code></a>.</p>
<p>Below is an example indicating how to to provision the Bootstrap Server and start the Client initiated Bootstrap. Be careful, if a Server is also configured, the Client will not go to Bootstrap mode and instead go to Registration mode on the configured Server.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;iowa_client.h&quot;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">prv_eventCallback</span><span class="p">(</span><span class="n">iowa_event_t</span> <span class="o">*</span><span class="n">eventP</span><span class="p">,</span>
                              <span class="kt">void</span> <span class="o">*</span><span class="n">userData</span><span class="p">,</span>
                              <span class="n">iowa_context_t</span> <span class="n">contextP</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">eventP</span><span class="o">-&gt;</span><span class="n">eventType</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">IOWA_EVENT_REG_UNREGISTERED</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Server (short ID: %d): Unregistered</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">serverShortId</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">IOWA_EVENT_REG_REGISTERING</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Server (short ID: %d): Registering</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">serverShortId</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">IOWA_EVENT_REG_REGISTERED</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Server (short ID: %d): Registered with lifetime %ds</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">serverShortId</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">details</span><span class="p">.</span><span class="n">registration</span><span class="p">.</span><span class="n">lifetime</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">IOWA_EVENT_REG_UPDATING</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Server (short ID: %d): Registration updating</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">serverShortId</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">IOWA_EVENT_REG_FAILED</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Server (short ID: %d): Registration failed.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">serverShortId</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">IOWA_EVENT_BS_PENDING</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Server (short ID: %d): Bootstrapping</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">serverShortId</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">IOWA_EVENT_BS_FAILED</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Server (short ID: %d): Bootstrap failed</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">serverShortId</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">IOWA_EVENT_BS_FINISHED</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Server (short ID: %d): Bootstrap finished</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventP</span><span class="o">-&gt;</span><span class="n">serverShortId</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">default</span><span class="o">:</span>
        <span class="c1">// Do nothing</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span>
         <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">iowa_context_t</span> <span class="n">iowaH</span><span class="p">;</span>
    <span class="n">iowa_status_t</span> <span class="n">result</span><span class="p">;</span>

    <span class="cm">/******************</span>
<span class="cm">     * Initialization</span>
<span class="cm">     */</span>

    <span class="n">iowaH</span> <span class="o">=</span> <span class="n">iowa_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

    <span class="n">iowa_client_configure</span><span class="p">(</span><span class="n">iowaH</span><span class="p">,</span> <span class="s">&quot;IOWA_Client&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">prv_eventCallback</span><span class="p">);</span>

    <span class="n">iowa_client_add_bootstrap_server</span><span class="p">(</span><span class="n">iowaH</span><span class="p">,</span>
                                     <span class="s">&quot;coap://localhost:5783&quot;</span><span class="p">,</span>
                                     <span class="n">IOWA_SEC_NONE</span><span class="p">);</span>

    <span class="cm">/******************</span>
<span class="cm">     * &quot;Main loop&quot;</span>
<span class="cm">     */</span>

    <span class="k">do</span>
    <span class="p">{</span>
        <span class="c1">// Run for 4 seconds</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">iowa_step</span><span class="p">(</span><span class="n">iowaH</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">IOWA_COAP_NO_ERROR</span><span class="p">)</span>

    <span class="n">iowa_client_remove_bootstrap_server</span><span class="p">(</span><span class="n">iowaH</span><span class="p">);</span>
    <span class="n">iowa_close</span><span class="p">(</span><span class="n">iowaH</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Once the Client starts:</p>
<ul>
<li>On first step loop, the <a href="../ClientAPI/#iowa_event_callback_t"><code>iowa_event_callback_t</code></a> callback is called to inform Bootstrap mode is beginning with event <code>IOWA_EVENT_BS_PENDING</code>,</li>
<li>When the Bootstrap Finish is received and if the Bootstrap Consistency is passed, the event callback is called with event <code>IOWA_EVENT_BS_FINISHED</code>,</li>
<li>After that the event callback gets called with event <code>IOWA_EVENT_REG_REGISTERING</code> to report that the Client is registering to the Server.</li>
</ul>
<p>If the Client is not able to register to the Server, the event callback is called with <code>IOWA_EVENT_REG_FAILED</code> and depending if a Bootstrap Server is configured, the Client:</p>
<ul>
<li>Automatically falls back to Bootstrap mode if a Bootstrap Server is configured,</li>
<li>Exits the step loop with <code>IOWA_COAP_503_SERVICE_UNAVAILABLE</code> if no Bootstrap Server is configured.</li>
</ul>
<p>The Bootstrap can fail (event <code>IOWA_EVENT_BS_FAILED</code>) when no command is received from the Bootstrap Server during a certain amount of time.</p>
<h3 id="iowa-client-with-security">IOWA Client (with Security)<a class="headerlink" href="#iowa-client-with-security" title="Permanent link">&para;</a></h3>
<p>The previous example can be extended to support the Security. This example serves just to demonstrate how to use IOWA security API. For instance, a better way could be to use a Secure element to store the security keys.</p>
<p>For this purpose, two structures are added to store the keys by Server Account: <em>security_t.serverUri</em>. The implementation uses the concept of Linked List with the help of IOWA API: [<code>IOWA_UTILS_LIST_ADD()</code>][IOWA_UTILS_LIST_ADD] and [<code>IOWA_UTILS_LIST_REMOVE()</code>][IOWA_UTILS_LIST_REMOVE].</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">security_data_t_</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">security_data_t_</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="n">iowa_security_data_t</span>     <span class="n">securityData</span><span class="p">;</span>
    <span class="kt">char</span>                    <span class="o">*</span><span class="n">serverUri</span><span class="p">;</span>
<span class="p">}</span> <span class="n">security_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">security_t</span> <span class="o">*</span><span class="n">security</span><span class="p">;</span>
<span class="p">}</span> <span class="n">client_data_t</span><span class="p">;</span>
</code></pre></div>

<p>The main is updated to pass the data security data structure:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;iowa_client.h&quot;</span><span class="cp"></span>

<span class="cp">#define SERVER_URI &quot;coaps:</span><span class="c1">//localhost:5784&quot;</span>

<span class="cp">#define PSK_CLIENT_IDENTITY   &quot;IOWA_CLIENT&quot;</span>
<span class="cp">#define PSK_CLIENT_KEY_LENGTH 10</span>
<span class="cp">#define PSK_CLIENT_KEY        {0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span>
         <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">iowa_context_t</span> <span class="n">iowaH</span><span class="p">;</span>
    <span class="n">iowa_status_t</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">client_data_t</span> <span class="n">clientData</span><span class="p">;</span>
    <span class="n">iowa_security_data_t</span> <span class="n">securityData</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">psk</span><span class="p">[</span><span class="n">PSK_CLIENT_KEY_LENGTH</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSK_CLIENT_KEY</span><span class="p">;</span>

    <span class="cm">/******************</span>
<span class="cm">     * Initialization</span>
<span class="cm">     */</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clientData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_data_t</span><span class="p">));</span>

    <span class="c1">// Add the Bootstrap Security key to the linked list</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">securityData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iowa_security_data_t</span><span class="p">));</span>
    <span class="n">securityData</span><span class="p">.</span><span class="n">securityMode</span> <span class="o">=</span> <span class="n">IOWA_SEC_PRE_SHARED_KEY</span><span class="p">;</span>
    <span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">PSK_CLIENT_IDENTITY</span><span class="p">);</span>
    <span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">PSK_CLIENT_IDENTITY</span><span class="p">,</span> <span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span><span class="p">);</span>

    <span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKeyLen</span> <span class="o">=</span> <span class="n">PSK_CLIENT_KEY_LENGTH</span><span class="p">;</span>
    <span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">PSK_CLIENT_KEY_LENGTH</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">psk</span><span class="p">,</span> <span class="n">PSK_CLIENT_KEY_LENGTH</span><span class="p">);</span>

    <span class="n">iowa_system_security_data</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">SERVER_URI</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">SERVER_URI</span><span class="p">),</span> <span class="n">IOWA_SEC_CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">securityData</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientData</span><span class="p">);</span>

    <span class="c1">// Initialize IOWA</span>
    <span class="n">iowaH</span> <span class="o">=</span> <span class="n">iowa_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clientData</span><span class="p">);</span>

    <span class="n">iowa_client_configure</span><span class="p">(</span><span class="n">iowaH</span><span class="p">,</span> <span class="s">&quot;IOWA_Client&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">iowa_client_add_bootstrap_server</span><span class="p">(</span><span class="n">iowaH</span><span class="p">,</span> <span class="n">SERVER_URI</span><span class="p">,</span> <span class="n">IOWA_SEC_PRE_SHARED_KEY</span><span class="p">);</span>

    <span class="cm">/******************</span>
<span class="cm">     * &quot;Main loop&quot;</span>
<span class="cm">     */</span>

    <span class="k">do</span>
    <span class="p">{</span>
        <span class="c1">// Run for 4 seconds</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">iowa_step</span><span class="p">(</span><span class="n">iowaH</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">IOWA_COAP_NO_ERROR</span><span class="p">)</span>

    <span class="n">iowa_client_remove_bootstrap_server</span><span class="p">(</span><span class="n">iowaH</span><span class="p">);</span>
    <span class="n">iowa_close</span><span class="p">(</span><span class="n">iowaH</span><span class="p">);</span>

    <span class="c1">// Remove the Bootstrap Security key</span>
    <span class="n">iowa_system_security_data</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">SERVER_URI</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">SERVER_URI</span><span class="p">),</span> <span class="n">IOWA_SEC_DELETE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientData</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>And <a href="../AbstractionLayer/#iowa_system_security_data"><code>iowa_system_security_data()</code></a> is expanded with the handle of <em>IOWA_SEC_CREATE</em> and <em>IOWA_SEC_DELETE</em> to support adding and removing keys by the Bootstrap Server.</p>
<div class="codehilite"><pre><span></span><code><span class="n">iowa_status_t</span> <span class="nf">iowa_system_security_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">peerIdentity</span><span class="p">,</span>
                                        <span class="kt">size_t</span> <span class="n">peerIdentityLen</span><span class="p">,</span>
                                        <span class="n">iowa_security_operation_t</span> <span class="n">securityOp</span><span class="p">,</span>
                                        <span class="n">iowa_security_data_t</span> <span class="o">*</span><span class="n">securityDataP</span><span class="p">,</span>
                                        <span class="kt">void</span> <span class="o">*</span><span class="n">userDataP</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">client_data_t</span> <span class="o">*</span><span class="n">clientDataP</span><span class="p">;</span>

    <span class="n">clientDataP</span> <span class="o">=</span> <span class="p">(</span><span class="n">client_data_t</span> <span class="o">*</span><span class="p">)</span><span class="n">userDataP</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">securityOp</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">IOWA_SEC_READ</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="n">security_t</span> <span class="o">*</span><span class="n">securityP</span><span class="p">;</span>

        <span class="n">securityP</span> <span class="o">=</span> <span class="n">clientDataP</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">securityP</span> <span class="o">!=</span> <span class="nb">NULL</span>
               <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">serverUri</span><span class="p">,</span> <span class="n">peerIdentity</span><span class="p">,</span> <span class="n">peerIdentityLen</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">securityP</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">securityP</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">IOWA_COAP_404_NOT_FOUND</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">securityMode</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">securityMode</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">securityMode</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="nl">IOWA_SEC_PRE_SHARED_KEY</span><span class="p">:</span>
            <span class="c1">// Copy the identity</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span><span class="p">;</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span><span class="p">;</span>

            <span class="c1">// Copy the private key</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">;</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKeyLen</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">IOWA_SEC_CERTIFICATE</span><span class="p">:</span>
            <span class="c1">// Copy the CA certificate</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span><span class="p">;</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificateLen</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificateLen</span><span class="p">;</span>

            <span class="c1">// Copy the certificate</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificate</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificate</span><span class="p">;</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificateLen</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificateLen</span><span class="p">;</span>

            <span class="c1">// Copy the private key</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">;</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKeyLen</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">IOWA_SEC_RAW_PUBLIC_KEY</span><span class="p">:</span>
            <span class="c1">// Copy the X public key</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span><span class="p">;</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyXLen</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyXLen</span><span class="p">;</span>

            <span class="c1">// Copy the Y public key</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyY</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyY</span><span class="p">;</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyYLen</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyYLen</span><span class="p">;</span>

            <span class="c1">// Copy the private key</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">;</span>
            <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKeyLen</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">case</span> <span class="nl">IOWA_SEC_CREATE</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="n">security_t</span> <span class="o">*</span><span class="n">newSecurityP</span><span class="p">;</span>

        <span class="n">newSecurityP</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">security_t</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">securityMode</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">securityMode</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">securityMode</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="nl">IOWA_SEC_PRE_SHARED_KEY</span><span class="p">:</span>
            <span class="c1">// Copy the identity</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span><span class="p">);</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identityLen</span><span class="p">;</span>

            <span class="c1">// Copy the private key</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">);</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKeyLen</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">IOWA_SEC_CERTIFICATE</span><span class="p">:</span>
            <span class="c1">// Copy the CA certificate</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificateLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificateLen</span><span class="p">);</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificateLen</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificateLen</span><span class="p">;</span>

            <span class="c1">// Copy the certificate</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificate</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificateLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificate</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificate</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificateLen</span><span class="p">);</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificateLen</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificateLen</span><span class="p">;</span>

            <span class="c1">// Copy the private key</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificate</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">);</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKeyLen</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">IOWA_SEC_RAW_PUBLIC_KEY</span><span class="p">:</span>
            <span class="c1">// Copy the X public key</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyXLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyXLen</span><span class="p">);</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyXLen</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyXLen</span><span class="p">;</span>

            <span class="c1">// Copy the Y public key</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyY</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyYLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyY</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyY</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyY</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyYLen</span><span class="p">);</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyYLen</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyYLen</span><span class="p">;</span>

            <span class="c1">// Copy the private key</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span><span class="p">);</span>
                <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyY</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">);</span>
            <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKeyLen</span> <span class="o">=</span> <span class="n">securityDataP</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKeyLen</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">serverUri</span> <span class="o">=</span> <span class="n">iowa_system_malloc</span><span class="p">(</span><span class="n">peerIdentityLen</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">serverUri</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">newSecurityP</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">IOWA_COAP_500_INTERNAL_SERVER_ERROR</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">newSecurityP</span><span class="o">-&gt;</span><span class="n">serverUri</span><span class="p">,</span> <span class="n">peerIdentity</span><span class="p">,</span> <span class="n">peerIdentityLen</span><span class="p">);</span>

        <span class="c1">// Add the new key</span>
        <span class="n">clientDataP</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="p">(</span><span class="n">security_t</span> <span class="o">*</span><span class="p">)</span><span class="n">IOWA_UTILS_LIST_ADD</span><span class="p">(</span><span class="n">clientDataP</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">,</span> <span class="n">newSecurityP</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">case</span> <span class="nl">IOWA_SEC_DELETE</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="n">security_t</span> <span class="o">*</span><span class="n">securityP</span><span class="p">;</span>

        <span class="n">securityP</span> <span class="o">=</span> <span class="n">clientDataP</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">securityP</span> <span class="o">!=</span> <span class="nb">NULL</span>
               <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">serverUri</span><span class="p">,</span> <span class="n">peerIdentity</span><span class="p">,</span> <span class="n">peerIdentityLen</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">securityP</span> <span class="o">=</span> <span class="n">securityP</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">securityP</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">IOWA_COAP_404_NOT_FOUND</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">securityMode</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="nl">IOWA_SEC_PRE_SHARED_KEY</span><span class="p">:</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">identity</span><span class="p">);</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">pskData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">IOWA_SEC_CERTIFICATE</span><span class="p">:</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">caCertificate</span><span class="p">);</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">certificate</span><span class="p">);</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">certData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">IOWA_SEC_RAW_PUBLIC_KEY</span><span class="p">:</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyX</span><span class="p">);</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">publicKeyY</span><span class="p">);</span>
            <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">securityData</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">rpkData</span><span class="p">.</span><span class="n">privateKey</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">clientDataP</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="p">(</span><span class="n">security_t</span> <span class="o">*</span><span class="p">)</span><span class="n">IOWA_UTILS_LIST_REMOVE</span><span class="p">(</span><span class="n">clientDataP</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">,</span> <span class="n">securityP</span><span class="p">);</span>

        <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="o">-&gt;</span><span class="n">serverUri</span><span class="p">);</span>
        <span class="n">iowa_system_free</span><span class="p">(</span><span class="n">securityP</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">default</span><span class="o">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">IOWA_COAP_NO_ERROR</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 IoTerop
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
      <a href="https://ioterop.com/" target="_blank" rel="noopener" title="Website" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M248 8C111.03 8 0 119.03 0 256s111.03 248 248 248 248-111.03 248-248S384.97 8 248 8zm82.29 357.6c-3.9 3.88-7.99 7.95-11.31 11.28-2.99 3-5.1 6.7-6.17 10.71-1.51 5.66-2.73 11.38-4.77 16.87l-17.39 46.85c-13.76 3-28 4.69-42.65 4.69v-27.38c1.69-12.62-7.64-36.26-22.63-51.25-6-6-9.37-14.14-9.37-22.63v-32.01c0-11.64-6.27-22.34-16.46-27.97-14.37-7.95-34.81-19.06-48.81-26.11-11.48-5.78-22.1-13.14-31.65-21.75l-.8-.72a114.792 114.792 0 01-18.06-20.74c-9.38-13.77-24.66-36.42-34.59-51.14 20.47-45.5 57.36-82.04 103.2-101.89l24.01 12.01C203.48 89.74 216 82.01 216 70.11v-11.3c7.99-1.29 16.12-2.11 24.39-2.42l28.3 28.3c6.25 6.25 6.25 16.38 0 22.63L264 112l-10.34 10.34c-3.12 3.12-3.12 8.19 0 11.31l4.69 4.69c3.12 3.12 3.12 8.19 0 11.31l-8 8a8.008 8.008 0 01-5.66 2.34h-8.99c-2.08 0-4.08.81-5.58 2.27l-9.92 9.65a8.008 8.008 0 00-1.58 9.31l15.59 31.19c2.66 5.32-1.21 11.58-7.15 11.58h-5.64c-1.93 0-3.79-.7-5.24-1.96l-9.28-8.06a16.017 16.017 0 00-15.55-3.1l-31.17 10.39a11.95 11.95 0 00-8.17 11.34c0 4.53 2.56 8.66 6.61 10.69l11.08 5.54c9.41 4.71 19.79 7.16 30.31 7.16s22.59 27.29 32 32h66.75c8.49 0 16.62 3.37 22.63 9.37l13.69 13.69a30.503 30.503 0 018.93 21.57 46.536 46.536 0 01-13.72 32.98zM417 274.25c-5.79-1.45-10.84-5-14.15-9.97l-17.98-26.97a23.97 23.97 0 010-26.62l19.59-29.38c2.32-3.47 5.5-6.29 9.24-8.15l12.98-6.49C440.2 193.59 448 223.87 448 256c0 8.67-.74 17.16-1.82 25.54L417 274.25z"/></svg>
      </a>
    
      
      
      <a href="https://github.com/IOTEROP" target="_blank" rel="noopener" title="GitHub" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
      <a href="https://twitter.com/ioteropcompany" target="_blank" rel="noopener" title="Twitter" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.fd16492e.min.js"></script>
      <script src="../assets/javascripts/bundle.7836ba4d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>